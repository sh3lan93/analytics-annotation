name: Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

# Ensure only one release workflow runs at a time
concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release and Tag
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for git-cliff
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: wrapper

    - name: Extract plugin version
      id: version
      run: |
        VERSION=$(grep "version = " plugin/build.gradle.kts | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" | head -1)
        TAG="v${VERSION}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Plugin Version: ${VERSION}"
        echo "ğŸ·ï¸  Tag Name: ${TAG}"

    - name: Check if tag already exists
      id: check_tag
      run: |
        if git rev-parse "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  Tag ${{ steps.version.outputs.tag }} already exists. Skipping release creation."
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "âœ… Tag ${{ steps.version.outputs.tag }} does not exist. Will create release."
        fi

    - name: Install git-cliff
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        curl -sSLf https://raw.githubusercontent.com/orhun/git-cliff/main/install.sh | bash
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Generate changelog for this release
      if: steps.check_tag.outputs.exists == 'false'
      id: changelog
      run: |
        # Get the previous tag
        PREVIOUS_TAG=$(git tag --sort=-version:refname --merged HEAD | head -1)

        if [ -z "$PREVIOUS_TAG" ]; then
          # If no previous tag exists, generate changelog from beginning
          echo "No previous tag found. Generating changelog from project inception."
          CHANGELOG=$(git-cliff --config cliff.toml --include-path 'plugin/**' --include-path 'core/**' --include-path 'annotation/**' --include-path 'compiler-plugin/**' 2>/dev/null || git-cliff --config cliff.toml 2>/dev/null)
        else
          # Generate changelog between previous tag and current commit
          echo "Generating changelog since $PREVIOUS_TAG"
          CHANGELOG=$(git-cliff --config cliff.toml --tag "${{ steps.version.outputs.tag }}" 2>/dev/null || echo "")
        fi

        # If git-cliff fails, use git log as fallback
        if [ -z "$CHANGELOG" ]; then
          echo "git-cliff failed, using git log fallback..."
          PREVIOUS_TAG=$(git tag --sort=-version:refname --merged HEAD | head -1)
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --oneline --pretty=format:"- %h: %s (%an)" | head -20)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --oneline --pretty=format:"- %h: %s (%an)")
          fi
        fi

        # Save changelog to file for next step
        echo "$CHANGELOG" > /tmp/changelog.txt
        cat /tmp/changelog.txt

        # Set it as output for GitHub Release
        {
          echo 'changelog<<EOF'
          cat /tmp/changelog.txt
          echo EOF
        } >> $GITHUB_OUTPUT

    - name: Create git tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.version }}"
        echo "âœ… Tag created: ${{ steps.version.outputs.tag }}"

    - name: Push tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git push origin "${{ steps.version.outputs.tag }}"
        echo "ğŸš€ Tag pushed to remote"

    - name: Create GitHub Release
      if: steps.check_tag.outputs.exists == 'false'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        release_name: Release ${{ steps.version.outputs.version }}
        body: |
          # Release ${{ steps.version.outputs.version }}

          **Plugin Version:** `${{ steps.version.outputs.version }}`

          ## Changes

          ${{ steps.changelog.outputs.changelog }}

          ---

          **Build Information:**
          - Workflow Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - Commit: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - Branch: `${{ github.ref_name }}`

          Generated by [GitHub Actions](https://github.com/features/actions)
        draft: false
        prerelease: false

    - name: Build artifacts
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        ./gradlew build -x test
        echo "âœ… Build artifacts created"

    - name: Comment on PR (if applicable)
      if: steps.check_tag.outputs.exists == 'false' && github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const version = '${{ steps.version.outputs.version }}';
          const tag = '${{ steps.version.outputs.tag }}';

          console.log(`âœ… Release workflow completed for ${tag}`);
          console.log(`ğŸ“¦ Plugin version: ${version}`);
          console.log(`ğŸ”— Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${tag}`);

    - name: Release already exists
      if: steps.check_tag.outputs.exists == 'true'
      run: |
        echo "â„¹ï¸  Tag ${{ steps.version.outputs.tag }} already exists."
        echo "ğŸ”— Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
        echo "No new release created."

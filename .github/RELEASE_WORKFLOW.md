# Release Workflow Documentation

## Overview

This project uses an automated GitHub Actions workflow to create tags and releases whenever changes are merged to the `main` branch. The workflow reads the plugin version from `plugin/build.gradle.kts` and creates a corresponding git tag and GitHub Release.

## üöÄ How It Works

### Trigger Events
The release workflow is triggered by:
1. **Automatic**: Any push to the `main` branch
2. **Manual**: Via GitHub Actions UI with `workflow_dispatch`

### Workflow Steps

1. **Extract Version**
   - Reads the plugin version from `plugin/build.gradle.kts`
   - Example: `2.0.0` ‚Üí tag: `v2.0.0`

2. **Check Existing Tags**
   - Verifies if the tag already exists
   - If it exists, skips release creation (prevents duplicates)
   - If new, proceeds to create release

3. **Generate Changelog**
   - Uses `git-cliff` to generate changelog from commits
   - References previous tag to show changes since last release
   - Falls back to `git log` if git-cliff fails

4. **Create Tag**
   - Creates an annotated git tag with the version
   - Configured by git with standard auth details

5. **Push Tag**
   - Pushes the tag to the remote repository
   - Triggers webhook notifications

6. **Create GitHub Release**
   - Creates a GitHub Release with:
     - Release notes from changelog
     - Build information and workflow link
     - Formatted markdown body

## üìã Key Features

### Idempotent Release Creation
- **Problem**: Multiple pushes shouldn't create duplicate releases
- **Solution**: Checks if tag exists before creating release
- **Result**: Safe to retry without side effects

### Changelog Integration
- Uses `git-cliff` for professional changelog generation
- Leverages existing `cliff.toml` configuration
- Groups commits by type (Features, Fixes, Refactor, etc.)
- Falls back gracefully if git-cliff unavailable

### Version Source of Truth
- Plugin version in `plugin/build.gradle.kts` is the single source of truth
- No separate version file or configuration needed
- Tag name matches version: `v2.0.0` for version `2.0.0`

### Build Artifacts
- Builds the project for each release (test skipped)
- Makes JAR/AAR files available for the release

## üîÑ Workflow in Action

### Example: Creating a New Release

```bash
# 1. Developer creates PR with features
git checkout -b feat/new-feature
echo "version = \"2.1.0\"" > plugin/build.gradle.kts
git commit -m "feat: add new feature
git push origin feat/new-feature

# 2. PR is reviewed and merged to main
# (GitHub UI or: git checkout main && git merge feat/new-feature && git push)

# 3. Release Workflow Triggers Automatically
# ‚úÖ Extracts version: 2.1.0
# ‚úÖ Creates tag: v2.1.0
# ‚úÖ Generates changelog from commits
# ‚úÖ Creates GitHub Release
# ‚úÖ Builds artifacts
```

### GitHub Release Output

```
Release 2.1.0

Plugin Version: 2.1.0

## Changes

### üöÄ Features
- Add new feature

### üìö Documentation
- Update README

---

Build Information:
- Workflow Run: [12345](...)
- Commit: [abc1234](...)
- Branch: main

Generated by GitHub Actions
```

## üîß Configuration

### Version Bumping

To create a new release, bump the version in `plugin/build.gradle.kts`:

```kotlin
// Before
version = "2.0.0"

// After (for patch release)
version = "2.0.1"

// After (for minor release)
version = "2.1.0"

// After (for major release)
version = "3.0.0"
```

Then commit and push to main. The workflow handles the rest!

### Git-Cliff Configuration

The workflow uses settings from `cliff.toml`:
- **Tag Pattern**: `v[0-9]*` - matches version tags
- **Commit Parsers**: Groups commits by type
- **Body Template**: Formats the changelog

To customize changelog appearance, modify `cliff.toml`.

## üìä Workflow File

**Location**: `.github/workflows/release.yml`

**Key Jobs**:
- `release` - Main release creation job

**Key Steps**:
- `checkout` - Get full git history
- `version` - Extract plugin version
- `check_tag` - Verify tag doesn't exist
- `changelog` - Generate release notes
- `tag` - Create git tag
- `push` - Push tag to remote
- `release` - Create GitHub Release

## üõ°Ô∏è Safety Features

### Tag Existence Check
Prevents duplicate releases if workflow reruns

### Fallback Changelog Generation
Uses `git log` if git-cliff unavailable

### No Repository Push Authorization Needed
Uses standard `GITHUB_TOKEN` which only works on current repo

### Atomic Operations
Either complete release succeeds fully or fails safely

## üö® Troubleshooting

### "Tag already exists"
This is normal if the version hasn't been bumped. Update the version in `plugin/build.gradle.kts` for a new release.

### "git-cliff not found"
The workflow installs git-cliff on demand. If installation fails, it falls back to git log.

### Changelog is empty
- Ensure commits follow [conventional commit](../COMMIT_CONVENTIONS.md) format
- Check that commit types are defined in `cliff.toml`
- Verify commits are between the tags git-cliff is analyzing

### Release not appearing
- Check GitHub Actions logs for workflow errors
- Verify you're on the `main` branch
- Confirm the tag was pushed: `git tag -l`

## üìö Related Documentation

- **Commit Conventions**: See [COMMIT_CONVENTIONS.md](COMMIT_CONVENTIONS.md)
- **Git-Cliff Config**: See `cliff.toml` in project root
- **Version Source**: See `plugin/build.gradle.kts`
- **GitHub Releases**: [GitHub Release Documentation](https://docs.github.com/en/repositories/releasing-projects-on-github/about-releases)

## üéØ Best Practices

1. **Bump version in dedicated commit**
   ```bash
   git commit -m "chore: Bump version to 2.1.0"
   ```

2. **Follow conventional commits**
   - Ensures changelog is organized and clear
   - See [COMMIT_CONVENTIONS.md](COMMIT_CONVENTIONS.md)

3. **Review changelog before merge**
   - Run `git-cliff` locally to preview
   - Install: See workflow for installation command

4. **Tag descriptions are auto-generated**
   - No need to create tags manually
   - Workflow handles everything

5. **One release per main branch push**
   - If multiple changes, batch them in one commit
   - Or create multiple PRs and batch-merge them

---

**Created**: November 10, 2024
**Workflow**: `.github/workflows/release.yml`
**Last Updated**: November 10, 2024